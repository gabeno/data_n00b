---
title: "exploring_kiva_data"
author: "Gabriel Majivu"
date: "11/29/2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)
```

## Data Overview

The data set used in this project is from [kiva](https://www.kiva.org/). The data has these variables:

1. __id__: unique id of the borrower
2. __name__: name of the borrower
3. __status__: current funding status that a loan has. Options include:
    * fundraising - The loan has not yet been funded. You can find the amount funded so far by checking _funded_amount_.
    * funded - This loan request has been completely funded and is not available for new loans by lenders.
    * in_repayment - The loan has been disbursed to the borrowers and they are in the process of using the funds and making payments on the loan to the field partner.
    * paid - The loan has been paid back in full by the borrower.
    * defaulted - A loan which has remained delinquent 6 months after the end of the loan payment schedule.
    * refunded - Refund the funded portion of the loan to lenders after the loan has been partially funded, fully funded, or even during repayment.
4. __funded_amount__: This is the amount of the loan which has been purchased by Kiva lenders.
5. __basket_amount__: This is the amount of the loan which lenders have saved in their shopping baskets, but has not been confirmed as purchased.
6. __activity__: Type of activity the borrower is involved with.
7. __sector__: Type of sector the borrower is involved in.
8. __themes__: General themes that further categorise borrowers.
9. __use__: Description for the purpose of the loan.
10. __partner_id__: Unique id for the field partners.
11. __posted_date__: The date the loan was posted on the Kiva website.
12. __planned_expiration_date__: The date the loan bid expires on the Kiva website. It is not set for some loans.
13. __loan_amount__: Amount of funding sought by the borrowers in a bid for a loan.
14. __borrower_count__: The number of borrowers for a loan. It is a good indication for single vs group borrowers.
15. __lender_count__: Number of lenders who have purchased a loan.
16. __bonus_credit_eligibility__: Whether a loan application is eligible for extra credit.
17. __tags__: Borrower chosen tags to classify their loan applications.
18. __description.languages__: Language choice(s) for the borrower.
19. __image.id__: Image ID for a borrower.
20. __image.template_id__: Image template id.
21. __location.country_code__: Country code of borrower.
22. __location.country__: Country name of borrower.
23. __location.town__ Town of the borrower.
24. __location.geo.level__: Level of accuracy of supplied [geometry](http://www.georss.org/model).
25. __location.geo.pairs__: The coordinate pairs for the geometry.
25. __location.geo.type__: The type of geometry defined by the coordinate pairs provided.
27. __currency_exchange_loss_amount__: Losses realized by the lender due to fluctuations in the value of the local currency against the US dollar. This will result in the paid amount of loan being less than the full loan amount even when the status of the loan is listed as _paid_.
28. __video.id__: Id for video.
29. __video.youtubeId__: Id for video on youtube.
30. __video.title__: Title of the video.
31. __video.thumbnailImageId__: Thumbnail id for the video.

## Loading Data

The data set sourced from [kiva api](http://build.kiva.org/docs/data) contains over 1.1 million loan records.

```{r echo=FALSE}
load('./loans.RData')
```

## Inspecting the loans dataframe

Check the top ten records.

```{r}
head(loans, 10)
```

Check the last 10 records.

```{r}
tail(loans, 10)
```

View the whole dataset.

```{r echo=FALSE}
View(loans)
```

Column names (see Data Overview section for descriptions):

```{r}
names(loans)
```

The shape of the data frame.

```{r}
dim(loans)
```

The structure of the data frame.

```{r}
str(loans)
```

Summary of the dataset

```{r}
summary(loans)
```

Check the number of NA per column

```{r}
character_cols <- names(loans)[sapply(loans, is.character)]
for(col in character_cols){
  na_strings <- sum(loans[[col]]=="NA")
  nas <- sum(is.na(loans[[col]]))
  print(paste(col, ": ", na_strings,',NA:' ,nas))
}
```

```{r}
sapply(loans, FUN = function(x) 100 * sum(is.na(x)) / dim(loans)[1])
```

## Data munging

Remove all columns that we may not need which include: _id_, _image.id_, _image.template_id_, _video.id_, _video.youtubeId_, _video.title_, _video.thumbnailImageId_, _description.languages_

```{r}
# drop variables we do not need
loans$id <- NULL
loans$image.id <- NULL
loans$image.template_id <- NULL
loans$video.id <- NULL
loans$video.youtubeId <- NULL
loans$video.title <- NULL
loans$video.thumbnailImageId <- NULL
loans$description.languages <- NULL
```

Set loans status as categories

```{r}
loans$status <- factor(loans$status,
                       levels = unique(loans$status),
                       labels = c("Fundraising", "Funded", "Expired"))
```

```{r}
table(loans$status)
```

Set sector as categories

```{r}
loans$sector <- factor(loans$sector)
```

Set latitude and longitude from _location.geo.pairs_

```{r}
loans <- separate(loans, location.geo.pairs, into=c('location.geo.lat', 'location.geo.long'), sep=' ', remove = TRUE)
loans$location.geo.lat <- as.numeric(loans$location.geo.lat)
loans$location.geo.long <- as.numeric(loans$location.geo.long)
```

Add a column to identify direct vs non-direct loans. Direct loans do not require field partners hence partner_id is null.

```{r}
# direct_loans <- loans[is.na(loans$partner_id), ]
# direct_loans$location.country_code
loans$direct <- as.numeric(is.na(loans$partner_id))
```

Add a column to indicate whether loan is borrowed by individual or a group.

```{r}
#loans$group <- as.integer(loans$borrower_count > 1)
```

## Exploratory Plots

### Variable: _funded_amount_

```{r}
summary(loans$funded_amount)
```

The lower median and higher mean suggest high value observations that skew the distribution to the right.

```{r}
ggplot(loans, aes(x=funded_amount)) + geom_histogram(binwidth = 200)
```

The plot shows a right skewed _funded_amount_ variable. Let us find a good cutoff for large loan amounts that will retain as much data and control the skew.

```{r}
# choosing a number of cutoff amounts
cut_off_amounts <- c(5000, 6000, 7000, 8000, 9000, 10000, 12500)
for(amount in cut_off_amounts){
    count <- sum(loans$funded_amount > amount)
    proportion <- 100 * count / dim(loans)[1]
    print(paste("cut_off_amount =", amount, ", count =", count,', proportion =' ,proportion, '%'))
}
```

__Notes__:

_funded_amount_ of USD 9,000 is a good pick for cut_off for large loan amounts. It only affects 1376 observations which is about 0.14% of all the records. Further, it is practically a large sum and may be safely ignored for purposes of studying microfinancing.

```{r}
loans_sub <- subset(loans, loans$funded_amount <= 9000)
```

Plotting with the new dataset

```{r}
ggplot(loans_sub, aes(x=funded_amount)) + geom_histogram(binwidth = 100)
```

### Variable: _loan_amount_

```{r}
summary(loans_sub$loan_amount)
```

Despite having capped the _funded_amount_ at USD 9,000 the _loan_amount_ shows that there were requests for higher amounts whi may have been under_funded. Perhaps a variable with rate of funding is important.

```{r}
ggplot(loans_sub, aes(x=loan_amount)) + geom_histogram(binwidth = 100)
```

### variable: _borrower_count_

```{r}
summary(loans$borrower_count)
```

```{r}
ggplot(loans, aes(x=borrower_count)) + geom_histogram(binwidth = 3)
```

Right skewed. Let us try to make groups for this variable. Proposed groups are:
* individual  = 1 persons
* small group = 2 - 9 persons
* large group = more than 10 people

```{r}
loans$group <- cut(loans$borrower_count, c(0,1,9,79), labels=c('Individual','Small','Large'), ordered_result = TRUE)
```

```{r}
ggplot(loans, aes(x=borrower_count, fill=group)) + geom_histogram(binwidth = 3)
```

```{r}
ggplot(loans, aes(group, borrower_count)) + geom_boxplot()
```

Perhaps introduce another sub-group to reduce the outliers in the "Large" sub-group.

### Variable: _lender_count_

```{r}
summary(loans$lender_count)
```

This variable also needs groups. Should the groupings be consistent with the one created from _borrower_count_?

### Variable: _status_

```{r}
levels(loans$status)
```

```{r}
table(loans$status)
```

```{r}
ggplot(loans, aes(status, ..count..)) + geom_bar()
```

status: __funding__ has the highest count in the dataset

### Variable: _sector_

```{r}
levels(loans$sector)
```

```{r}
table(loans$sector)
```

```{r}
ggplot(loans, aes(sector, ..count..)) + geom_bar() + theme(axis.text.x = element_text(angle=90, hjust=0, vjust=0))
```

Most popular sectors include "agriculture", "food", "retail".

__Note__: explore elationship with funded loan amounts.

### Variable: _bonus_credit_eligibility_

```{r}
levels(loans$bonus_credit_eligibility)
```

```{r}
table(loans$bonus_credit_eligibility)
```

```{r}
ggplot(loans, aes(bonus_credit_eligibility, ..count..)) + geom_bar()
```

### Variable: _group_

```{r}
table(loans$group)
```

```{r}
ggplot(loans, aes(group, ..count..)) + geom_bar()
```

There are many individual borrowers.


### new variables

### _funding_rate_

This variable defines the rate of success in funding bid by the borrower, in other words how much of the original sought amount was actually funded?

```{r}
loans$funding_rate <- 100*loans$funded_amount / loans$loan_amount
summary(loans$funding_rate)
```


```{r}
ggplot(loans, aes(x=funding_rate, fill=status)) + geom_histogram(binwidth = 5) + facet_grid(~status)
```

As expected, loans with status "funding" have highest _funding_rate_ in comarison with the others which have 0%.

```{r}
sum(loans[["funding_rate"]] == 0)
```

```{r}
100*sum(loans[["funding_rate"]] == 0)/dim(loans)[1]
```

Only 0.26% of all loans in the data set have 0% funding rate - from the plot above they are either in the fundraising stage or expired. This dataset has the bulk of the loans fulfilled by lenders.


### _funding_duration_

This variable defines the period (in days) it takes for a loan to be bought by the lenders.

```{r}
loans$funding_duration <- as.Date(loans$planned_expiration_date) - as.Date(loans$posted_date)
loans$funding_duration <- as.integer(loans$funding_duration)
```

```{r}
summary(loans$funding_duration)
```

The NAs are due to some loan applications missing a _planned_expiration_date_. We could set these to have the median value.

```{r}
mean_duration <- mean(loans$funding_duration, na.rm = TRUE)
loans$funding_duration[is.na(loans$funding_duration)] <- mean_duration
summary(loans$funding_duration)
```

There is an outlier that is skewing this dataseat to the extreme right - it has a very high value for the duration. Ideally such a high duration is not practical since a loan can not stay for that long at a "fundraising stage".

```{r}
sum(loans[["funding_duration"]] > 90)
```


```{r}
ggplot(subset(loans, loans$funding_duration <= 90), aes(x=funding_duration)) + geom_histogram(binwidth = 5)
```


---

Q: What is the distribution of funded amounts?

```{r}
ggplot(subset(loans, loans$funded_amount < 10000), aes(x=funded_amount)) + geom_histogram(binwidth = 200)
```

```{r}
# subset
sum(loans$funded_amount > 10000)
```


```{r}
ggplot(subset(loans, loans$funded_amount < 10000), aes(status, funded_amount)) + geom_boxplot()
```

```{r}
ggplot(loans, aes(x=funded_amount, fill=sector, color=sector)) + geom_histogram(binwidth = 1000)
```

__Notes__:
* Right skewed bar plot. Most loans that receive funding are for small amounts. There appears to be a couple of large loan amounts though they must be quite few.
* Do I remove high value loans to aid visualization?
* If yes, what cutoff do I use?

Q Is there any relation between _lender_count_ and _funded_amount_? (Is there a group effect on the lenders with regard to the loan amounts?)

```{r}
ggplot(loans, aes(x=lender_count, y=funded_amount)) + geom_jitter()
```

__Notes__:
There seems to be a relation between number of lenders (_lender_count_) and the loan amounts (_funded_amount_). Higher loan amounts attract more lenders perhaps due to the liability involved and the financial capabilities of the lenders.

Q Are lenders biased against sinlge or goup borrowers?

```{r}
ggplot(loans, aes(x=lender_count, y=borrower_count)) + geom_jitter()

# add a plot between lender count vs single and group
```

__Notes__:
Not sure there is a relationship here.

Q Do groups (multiple borrowers) seek larger amounts as compared to individual borrowers?

new variable -> $/person

```{r}
ggplot(loans, aes(x=funded_amount, y=borrower_count)) + geom_jitter()
```

__Notes__:
Note sure if these are correlated.

Q What is the distribution of the borrowers?

```{r}
ggplot(loans, aes(status, borrower_count)) + geom_boxplot()
```

```{r}
ggplot(loans, aes(sector, borrower_count)) + geom_boxplot() + theme(axis.text.x = element_text(angle=90, hjust=0, vjust=0))
```
visualize on borrower_count and get some direction on it.


Q Does sector the borrower is in affect the loan amounts they attract?

```{r}
ggplot(loans, aes(x=funded_amount, y=sector)) + geom_jitter()
```

Possibly remove high loan amount?
mean funded_amount


---
title: "Exploring Kiva Loans Data"
author: "Gabriel Majivu"
date: "11/29/2016"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Libraries

```{r}
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)
library(stringr)
library(scales)
```


### About

[Kiva](https://www.kiva.org/about) is an international non-profit that allows people to lend money to low-income entrepreneurs and students in over 80 countries. Its mission is to enable people to create opportunity for themselves and for others.


### Loans Data Overview

The [data](http://build.kiva.org/docs/data/loans) set used in this project has these variables:

1. __id__: unique id of the borrower
2. __name__: name of the borrower
3. __status__: current funding status that a loan has. Options include:
    * fundraising - The loan has not yet been funded. You can find the amount funded so far by checking _funded_amount_.
    * funded - This loan request has been completely funded and is not available for new loans by lenders.
    * in_repayment - The loan has been disbursed to the borrowers and they are in the process of using the funds and making payments on the loan to the field partner.
    * paid - The loan has been paid back in full by the borrower.
    * defaulted - A loan which has remained delinquent 6 months after the end of the loan payment schedule.
    * refunded - Refund the funded portion of the loan to lenders after the loan has been partially funded, fully funded, or even during repayment.
4. __funded_amount__: This is the amount of the loan which has been purchased by Kiva lenders.
5. __basket_amount__: This is the amount of the loan which lenders have saved in their shopping baskets, but has not been confirmed as purchased.
6. __activity__: Type of activity the borrower is involved with.
7. __sector__: Type of sector the borrower is involved in.
8. __themes__: General themes that further categorise borrowers.
9. __use__: Description for the purpose of the loan.
10. __partner_id__: Unique id for the field partners.
11. __posted_date__: The date the loan was posted on the Kiva website.
12. __planned_expiration_date__: The date the loan bid expires on the Kiva website. It is not set for some loans.
13. __loan_amount__: Amount of funding sought by the borrowers in a bid for a loan.
14. __borrower_count__: The number of borrowers for a loan. It is a good indication for single vs group borrowers.
15. __lender_count__: Number of lenders who have purchased a loan.
16. __bonus_credit_eligibility__: Whether a loan application is eligible for extra credit.
17. __tags__: Borrower chosen tags to classify their loan applications.
18. __description.languages__: Language choice(s) for the borrower.
19. __image.id__: Image ID for a borrower.
20. __image.template_id__: Image template id.
21. __location.country_code__: Country code of borrower.
22. __location.country__: Country name of borrower.
23. __location.town__ Town of the borrower.
24. __location.geo.level__: Level of accuracy of supplied [geometry](http://www.georss.org/model).
25. __location.geo.pairs__: The coordinate pairs for the geometry.
25. __location.geo.type__: The type of geometry defined by the coordinate pairs provided.
27. __currency_exchange_loss_amount__: Losses realized by the lender due to fluctuations in the value of the local currency against the US dollar. This will result in the paid amount of loan being less than the full loan amount even when the status of the loan is listed as _paid_.
28. __video.id__: Id for video.
29. __video.youtubeId__: Id for video on youtube.
30. __video.title__: Title of the video.
31. __video.thumbnailImageId__: Thumbnail id for the video.


### Loading Data

The data was sourced from [kiva api](http://build.kiva.org/docs/data) via [this script](https://github.com/gabeno/data_n00b/blob/master/foundations_of_data_science/capstone_project/data.source.final.R) and saved as an _RData_ file. The data set contains over 1.1 million loan observations.

```{r echo=FALSE}
load('./loans.RData')
```


### Kiva by numbers

A brief look into the data set highlighting important numbers:

```{r}
length(unique(loans$location.country_code))
```

The Kiva dataset has 91 countries represented.

```{r}
length(unique(loans$id))
```

Over 1.1M borrowers have sought funding through Kiva.

```{r}
sum(loans[['funded_amount']])
```

Total amount of funding is $949M.

```{r}
sum(loans[['funded_amount']]) / sum(loans[['loan_amount']]) * 100
```

Repayment rate is 96.4%.


### Inspecting the loans dataframe

Check a sample of the observations

```{r}
head(loans, 10)
```


```{r}
tail(loans, 10)
```

View the whole dataset.

```{r echo=FALSE}
View(loans)
```

Names for columns in the dataset (see Data Overview section for descriptions):

```{r}
names(loans)
```

The dimensions of the loans dataframe.

```{r}
dim(loans)
```

The structure of the loans dataframe.

```{r}
str(loans)
```

Summary of the dataset

```{r}
summary(loans)
```


### Data munging

Check the number of null values (_NAs_) per variable

```{r}
character_cols <- names(loans)[sapply(loans, is.character)]
for(col in character_cols){
  na_strings <- sum(loans[[col]]=="NA")
  nas <- sum(is.na(loans[[col]]))
  print(paste(col, ": ", na_strings,',NA:' ,nas))
}
```

Check the proportion of null values (_NAs_) per variable

```{r}
sapply(loans, FUN = function(x) 100 * sum(is.na(x)) / dim(loans)[1])
```

Remove columns that we may not need which include: _id_, _image.id_, _image.template_id_, _video.id_, _video.youtubeId_, _video.title_, _video.thumbnailImageId_

```{r}
loans$id <- NULL
loans$image.id <- NULL
loans$image.template_id <- NULL
loans$video.id <- NULL
loans$video.youtubeId <- NULL
loans$video.title <- NULL
loans$video.thumbnailImageId <- NULL
```

Each loan has a status at any given time. We set these loan statuses as factors:

```{r}
loans$status <- factor(loans$status,
                       levels = unique(loans$status),
                       labels = c("Fundraising", "Funded", "Expired"))
table(loans$status)
```

Similarly, we set loan sector as categories:

```{r}
loans$sector <- factor(loans$sector)
table(loans$sector)
```

We also set latitude and longitude from _location.geo.pairs_

```{r}
loans <- separate(loans, location.geo.pairs, into=c('location.geo.lat', 'location.geo.long'), sep=' ', remove = TRUE)
loans$location.geo.lat <- as.numeric(loans$location.geo.lat)
loans$location.geo.long <- as.numeric(loans$location.geo.long)
```

Most loans are administered through Kiva field partners. However, some loans are given directly to the borrowers. These are identified as _direct_ loans. We add a column to identify direct vs non-direct loans. Direct loans do not require field partners hence partner_id is null.

```{r}
loans$direct <- as.numeric(is.na(loans$partner_id))
```


### Exploratory Plots

This section aims to gain insights for some variables of interest.

#### status

_status_ informs on the stage a loan has. There are a number of stages as outlined in the Kiva website. Loans for this dataset have the following status:

```{r}
levels(loans$status)
```

Here is the distribution by status of the loan.

```{r}
status_dist <- data.frame(table(loans$status))
status_dist$Percentage <- status_dist$Freq / sum(status_dist$Freq) * 100
colnames(status_dist) <- c('Status', 'Frequency', 'Percentage')
status_dist
```

95.54% of the loans have been funded and only 0.62% are in the fundraising stage. Unfortunately, the "Expired" status has not been explained on the kiva website. Since it is ambiguous, we shall remove the affected rows from the dataset.

```{r}
loans <- subset(loans, status=='Fundraising' | status=='Funded')
```

A plot for the status variable:

```{r}
ggplot(loans, aes(status, ..count..)) +
    geom_bar(width=.2) +
    scale_y_continuous(labels = comma) +
    labs(x = "Loan Status", y = "Count", title = "Loan Status by count") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

#### loan_amount

```{r}
summary(loans$loan_amount)
```

The average amount of loan borrowed is $813. We also observe that the median is lower than the mean by a few hundreds of dollars. This points to existence of high loan amounts. The lowest amount requested is $25, the highest being $10,000.

```{r}
ggplot(loans, aes(x=loan_amount)) +
    geom_histogram(binwidth = 200) +
    scale_y_continuous(labels = comma) +
    scale_x_continuous(labels = comma) +
    labs(x = "Loan Amount", y = "Count", title = "Loan amount") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

There are a number high loan amounts that cause skew on the plot. Since the focus on this study is to evaluate microloans, we need to compute a sensible cutoff to remove the high loan amounts.

```{r}
# choosing a number of cutoff amounts
cut_off_amounts <- c(5000, 6000, 7000, 8000, 9000, 10000, 11000, 12000)
for(amount in cut_off_amounts){
    count <- sum(loans$loan_amount > amount)
    proportion <- 100 * count / dim(loans)[1]
    print(paste("cut_off_amount =", amount, ", count =", count,', proportion =' ,proportion, '%'))
}
```

For a cutoff at an amount of $9,000 only 1,391 observations will be removed. This represents about 0.13% of data. Further, $9,000 is practically a large sum and any amount above it may be safely ignored for purposes of our study.

```{r}
loans <- subset(loans, loans$loan_amount <= 9000)
summary(loans$loan_amount)
```

With the new dataset, 75% of the loan amounts borrowed are less or equal to $1000 and half the loans are not more than $500. The average amount of loan borrowed is $799.50.

```{r}
ggplot(loans, aes(x=loan_amount)) + 
    geom_histogram(binwidth = 200) +
    scale_y_continuous(labels = comma) +
    scale_x_continuous(labels = comma) +
    labs(x = "Loan Amount", y = "Count", title = "Loan Amount Distribution") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

Here, it is much clearer that most borrowers go for less than $1,250 (3rd qurtile amount is $1,000).

#### funded_amount

```{r}
summary(loans$funded_amount)
```

The average funded amount for a loan is $794.20. Some loans have $0 funding - these are probably loans under fundraising.
We have a naive funding success rate of 96.5% by comparing with the average loan amount.

```{r}
ggplot(loans, aes(x=funded_amount)) + 
    geom_histogram(binwidth = 200) +
    scale_y_continuous(labels = comma) +
    scale_x_continuous(labels = comma) +
    labs(x = "Funded Amount", y = "Count", title = "Funded Amount Distribution") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

The plot shows a similar distribution to that of _loan_amount_. The _funded_amount_ is a proportion of the _loan_amount_ as bid by the lenders. Perhaps there could be cases where a loan is oversubscribed. We shall see if this is the case in further analysis.

#### borrower_count

```{r}
summary(loans$borrower_count)
```


```{r}
ggplot(loans, aes(x=borrower_count)) + 
    geom_histogram(binwidth = 3) +
    scale_y_continuous(labels = comma) +
    scale_x_continuous(labels = comma) +
    labs(x = "Borrower Count", y = "Count", title = "Borrower Count Distribution") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

Most loans have individual borrowers or small groups i.e. few people borrowing together. The _borrower_count_ might be more valuable if it is transformed to categories with specific number of people. Making groups for this variable thus:
* individual  = 1 persons
* small group = 2 - 9 persons
* large group = more than 10 persons

We therefore create a new variable _borrower_group_

```{r}
loans$borrower_group <- cut(loans$borrower_count,
                            c(0,1,9,79),
                            labels=c('Individual','Small','Large'),
                            ordered_result = TRUE)
```

Plotting the new _borrower_group_ variable:

```{r}
ggplot(loans, aes(x=borrower_group)) + 
    geom_bar(width = .2) +
    scale_y_continuous(labels = comma) +
    labs(x = "Borrower Group", y = "Count", title = "Borrower Group Count") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

How does a box plot of the same variable look like?

```{r}
ggplot(loans, aes(borrower_group, borrower_count)) + 
    geom_boxplot() +
    labs(x = "Borrower Group", y = "Count", title = "Borrower Groups") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

The "Large" group shows the greatest variability. It has considerable outliers but since the overall count in this group is small (as seen from the preceding plot) it is not necessary to break it down further. The average for each group is 1, 5, and 14 respectively.

#### lender_count

This variable probably also needs grouping. We could apply the same treatment on this group as the _borrower_count_.

```{r}
summary(loans$lender_count)
```

Lender group average 23 persons per loan. Lenders tend to spread their risk by grouping and buying into loans in small amounts

```{r}
ggplot(loans, aes(x=lender_count)) +
    geom_histogram(binwidth = 5) +
    scale_y_continuous(labels = comma) +
    labs(x = "Lender Count", y = "Count", title = "Lender Count Distribution") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

From the plot we see most loans having fewer than 50 lenders. We can create 3 lender groups thus:
* small group  = less than 10 persons
* medium group = 10 - 50 persons
* large group = more than 50 persons

```{r}
loans$lender_group <- cut(loans$lender_count, c(0,10,50,2986),
                          labels=c('Small', 'medium','Large'),
                          ordered_result = TRUE,
                          include.lowest = TRUE)
```

Plotting the new _borrower_group_ variable:

```{r}
ggplot(loans, aes(x=lender_group)) +
    geom_bar(width = .2) +
    scale_y_continuous(labels = comma) +
    labs(x = "Lender Group", y = "Count", title = "Lender Group Count") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

From the plot we see most loans belong to the medium group (10 - 50 lenders). Loans which attract more than 100 lenders are much fewer than the other two categories combined. THis is also exlplained by the fact that loans with high amounts are much less and it is these loans that would require many more lenders to combine effort - perhaps to minimize their risk.

#### sector

Borrowers have to fill in the sector in which they operate. This variable may be used to assess the purpose of funding. The sectors in this dataset are:

```{r}
levels(loans$sector)
```

By count and proportion:

```{r}
table(loans$sector)
```

```{r}
sector_dist <- data.frame(sort(table(loans$sector), decreasing = TRUE))
sector_dist$Percentage <- sector_dist$Freq / sum(sector_dist$Freq) * 100
colnames(sector_dist) <- c('Sector', 'Frequency', 'Percentage')
sector_dist
```

A plot to visualize the information above:

```{r}
ggplot(sector_dist, aes(Sector, Frequency)) + 
    geom_bar(stat="identity", width = .6) +
    scale_y_continuous(labels = comma) +
    labs(x = "Sector", y = "Count", title = "Sectors Count") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm'), angle=90, hjust=0, vjust=0))
```

Evidently, the most popular sectors include "agriculture", "food", "retail". It seems accessing food is the most important activity on the basis of "agriculture"" and "food" sectors topping. Another observation is that small scale business ventures like "retail"" and "services" rank higher than the more capital intensive ventures like "construction", "manufacturing" and "wholesale". "entertainment" is the least popular sector - no one wants to fund leisure activities.

#### funding_rate

This variable defines the rate of success in funding bid by the borrower, in other words how much of the original sought amount was actually funded?

```{r}
loans$funding_rate <- 100*loans$funded_amount / loans$loan_amount
summary(loans$funding_rate)
```

The average rate of funding is 99.43%. Funding rate is considered as the proportion of loan which a lender bought. We do not have a loan which was overfunded.

```{r}
sum(loans[["funding_rate"]] == 100)
```

There are 1,122,521 loans which are fully funded at 100%. The rest,

```{r}
sum(loans[["funding_rate"]] < 100) # => 7,217
```

are underfunded. Could these be loans in fundraising stage?

```{r}
length(subset(loans, loans$funding_rate < 100)[['status']]) # => 7,217
```

... and Yes, they are loans in "fundraising" stage. 

One of the objectives of this project was to assess the probability of successful funding for a loan application. The variable _funding_rate_ was meant to be our response variable. The dataset contains high success rate with underfunded loans being the only one not fully funded. This makes our objective impossible to achieve.

### funding_duration

This variable defines the period (in days) it takes for a loan to be bought by the lenders.

```{r}
loans$funding_duration <- as.Date(loans$planned_expiration_date) - as.Date(loans$posted_date)
loans$funding_duration <- as.integer(loans$funding_duration)
```

```{r}
summary(loans$funding_duration)
```

The NAs are due to some loan applications missing a _planned_expiration_date_. We could set these to have the median value.

```{r}
mean_duration <- mean(loans$funding_duration, na.rm = TRUE)
loans$funding_duration[is.na(loans$funding_duration)] <- mean_duration
summary(loans$funding_duration)
```

The max value points to a loan which has a very long duration. Ideally such a high duration is not practical since a loan should not stay for that long at "fundraising stage". If we consider a maximum period of 90 days as the funding period, then 339 observations are affected. 90 days is reasonable because it is a common credit period in the finance world.

```{r}
sum(loans[["funding_duration"]] > 90)
```

Further, since there is very little variablity (median and mean values are very close), we can create groups for the funding duration treating them as categories:

* low = less than or equal to 30 days
* high = more than 30 days

```{r}
loans$funding_duration <- cut(loans$funding_duration, c(0, 30, 1674),
                          labels=c('Low','High'),
                          ordered_result = TRUE,
                          include.lowest = TRUE)
```


```{r}
ggplot(loans, aes(funding_duration, ..count..)) + 
    geom_bar(width = .4) +
    scale_y_continuous(labels = comma) +
    labs(x = "Funding Group", y = "Count", title = "Funding Duration") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

More loans are funded within 30 days. Perhaps this goes with the thought that most loan amounts are small thereby they do not need a lot of time to seek funding.

#### country

Loan applicants register their country when they apply for loans.

```{r}
loans$country <- factor(loans$location.country)
table(loans$country)
```

```{r}
country_dist <- data.frame(sort(table(loans$country), decreasing = TRUE))
country_dist$Percentage <- country_dist$Freq / sum(country_dist$Freq) * 100
colnames(country_dist) <- c('Country', 'Frequency', 'Percentage')
country_dist
```

Let us plot it for easier visual analysis:

```{r, fig.width = 8, fig.height = 6}
ggplot(country_dist, aes(Country, Frequency)) + 
    geom_bar(stat="identity") +
    scale_y_continuous(labels = comma) +
    labs(x = "Country", y = "Count", title = "Loan Counts Per Country") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm'))) +
    theme(axis.text.x = element_text(angle=90, hjust=0, vjust=0, size=12))
```

Kenya and Phillipines have the high counts for borrowers. Perhaps it would be intersting to complement this dataset with one with economic ranking for countries to understand if there is a relationship.

The top ten countries by loan count:
 - Phillipines (19.4%)
 - Kenya (10.0%)
 - Peru (6.78%)
 - Cambodia (5.34%)
 - El Salvador (4.53%)
 - Uganda (3.34%)
 - Nicaragua (3.28%)
 - Tajikistan (2.98%)
 - Pakistan (2.86%)
 - Equador (2.38%)
 
```{r}
country_top_ten <- country_dist[1:10,]
ggplot(country_top_ten, aes(Country, Frequency), fill=loans$sector) + 
    geom_bar(stat="identity", width = .4) + 
    scale_y_continuous(labels = comma) +
    labs(x = "Country", y = "Count", title = "Top Ten Loan Counts Per Country") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm'))) +
    theme(axis.text.x = element_text(angle=90, hjust=0, vjust=0, size=rel(1.2)))
```
 

```{r, fig.width = 8, fig.height = 6}
loans_top_ten <- subset(loans, loans$country %in% country_top_ten[['Country']])
ggplot(loans_top_ten, aes(country, ..count.., fill=sector)) + 
    geom_bar(position='dodge') +
    scale_y_continuous(labels = comma) +
    labs(x = "Country", y = "Count", title = "Top Ten Countries By Sector") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

Lets plot the top 5 sectors per country.

```{r}
loans_top_ten_grouped <- group_by(loans_top_ten, country, sector)
per_sector <- loans_top_ten_grouped %>% 
    summarise(count_per_sector=n()) %>% 
    mutate(prop = 100*count_per_sector/sum(count_per_sector)) %>% 
    arrange(country, desc(count_per_sector)) %>% 
    slice(seq(5))
per_sector
```

```{r}
ggplot(per_sector, aes(country, prop, fill=sector)) + 
    geom_bar(stat='identity', position = 'dodge', width = .6) +
    scale_y_continuous(labels = comma) +
    labs(x = "Country", y = "% Count", title = "Top Ten Countries By Top Five Sectors") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm'))) +
    theme(axis.text.x = element_text(angle=90, hjust=0, vjust=0, size=rel(1.2)))
```

Sectors in the plot above attract most of the microlending spend. They can be viewed as sectors through which poverty reduction efforts are addressed.

Sectors present in all top ten countries are "Agriculture" and "Food". "Retail" closely follows missing only in Cambodia. "Agriculture" tops in 5 countries (Cambodia, Equador, El Savaldor, Kenya and Tajikistan) followed by "Retail" in 2 countries (Phillipines and Nicaragua), "Food" in 2 countries (Peru and Uganda) and "Services" in 1 country (Pakistan).

### description languages

These are languages borrowers choose to use for their loan applications.

```{r}
loans$num_languages <- str_count(loans$description.languages, ',') + 1
```

```{r}
summary(loans$num_languages)
```

```{r}
loans_prop <- loans %>% 
    group_by(num_languages) %>% 
    summarise(count=n()) %>% 
    mutate(percent=100*count/sum(count))
ggplot(loans_prop, aes(num_languages, percent)) + 
    geom_bar(stat="identity") +
    scale_y_continuous(labels = comma) +
    labs(x = "# Languages", y = "% Count", title = "Languages Proportion") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

Most borrower profiles have only one language selected. This is about twice as much as the single language profiles - about 68% for single language profile viz 30% for profiles with two languages. It is of interest checking what languages if any the lenders have on their profiles and if they influence decision to buy loans (loans whose profile owners have same language as themselves).

### loan_amount vs borrower_count

```{r}
loans$amt_borrower_ratio <- loans$loan_amount / loans$borrower_count
summary(loans$amt_borrower_ratio)
```

```{r}
ggplot(loans, aes(x=amt_borrower_ratio)) + 
    geom_histogram(binwidth = 50) +
    scale_x_continuous(labels = comma) +
    scale_y_continuous(labels = comma) +
    labs(x = "$ / Borrower", y = "Count", title = "Loan Amount / Borrower Count Ratio") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

```{r}
ggplot(loans, aes(x=amt_borrower_ratio)) + 
    geom_density(adjust = 5) +
    scale_x_continuous(labels = comma) +
    scale_y_continuous(labels = comma) +
    labs(x = "$ / Borrower", y = "Count", title = "Loan Amount / Borrower Count Ratio") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

Loan amount per borrower assumes a right skewed shape. This implies that borrowers seek loans for small amounts. The most common amount is about $300. From the summary calculation, the average amount per borrower is $580 while 75% are less than $725. The other 25% are high loan amounts up to a maximum of $9,000. The smoothened density plot show the unimodal nature of the data. 

### loan_amount vs lender_count

```{r}
loans_with_lenders <- subset(loans, lender_count > 0)
loans_with_lenders$amt_lender_ratio <- loans_with_lenders$loan_amount / loans_with_lenders$lender_count
summary(loans_with_lenders$amt_lender_ratio)
```

THe average Dollar amount per lender is $30. This means many more lenders combine effort to satisfy a loan bid. Previously we saw an average loan amount of $580 leading us to conclude that on average a loan requires at least 19 lenders and points to the fact that lenders tend to spread their risk by buying many loans in small amounts.

The maxmimum amount though is quite out of the ordinary, looks like some lenders made huge investments. We shall try to adjust 

```{r}
loans_with_lenders <- subset(loans_with_lenders, amt_lender_ratio < 1000)
ggplot(loans_with_lenders, aes(x=amt_lender_ratio)) + 
    geom_histogram(binwidth = 30) +
    scale_x_continuous(labels = comma) +
    scale_y_continuous(labels = comma) +
    labs(x = "$ / Lenders", y = "Count", title = "Loan Amount / Lender Count Ratio") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

```{r}
ggplot(loans_with_lenders, aes(x=amt_lender_ratio)) + 
    geom_density(adjust = 5) +
    scale_x_continuous(labels = comma) +
    scale_y_continuous(labels = comma) +
    labs(x = "$ / Lender", y = "Count", title = "Loan Amount / Lender Count Ratio") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm')))
```

The lender ratio has a very narrow range beyond which it assumes huge values. Lenders tend to either place small amounts when they buy loans while others place big amounts. Majority of them place small amounts.


### Further Analysis

```{r, fig.width=6, fig.height=3}
median_per_sector <- group_by(loans, sector) %>% summarise(med=median(funded_amount))
ggplot(median_per_sector, aes(x=sector, y=med)) + 
    geom_bar(stat="identity", width = .4) +
    labs(x = "Sector", y = "Average Funded Amount", title = "Average Spend Per Sector") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm'))) +
    theme(axis.text.x = element_text(angle=90, hjust=0, vjust=0, size=rel(1.2)))
```

"Wholesale" sector has the highest median value. Together with "Construction", "Education", "Entertainment" and "Health", their median values exceed $600. Typically, these sectors demand high dollar amounts - like doing a housing project or funding medication can be very expensive. On the other hand, highly frequent sectors like "Agriculture", "Food" and "Retail" attract small investment amounts - like small retail groceries business and small scale farming.

```{r, fig.width=6, fig.height=3}
median_per_country <- group_by(loans, country) %>% summarise(med=median(funded_amount))
ggplot(median_per_country, aes(x=country, y=med)) + 
    geom_bar(stat="identity", width = .6) +
    scale_y_continuous(labels = comma) +
    labs(x = "Country", y = "Median Funded Amount", title = "Median Loan By Country") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm'))) +
    theme(axis.text.x = element_text(angle=90, hjust=0, vjust=0, size=rel(1.2)))
```

Botswana stands out as having the highest median value _funded_amount_. Majority of the other countries have less than $1,000 median values with just a few having $2,000 and above. This confirms our idea that Kiva largely support microlending.

```{r}
lender_prop <- loans %>% 
    group_by(sector, lender_group) %>% 
    summarise(n=n()) %>% 
    mutate(percent=100*n/sum(n))
ggplot(lender_prop, aes(sector, percent, color=lender_group, fill=lender_group)) + 
    geom_bar(position="dodge", stat = "identity") +
    labs(x = "Sector", y = "% Count", title = "% Lenders By Sector") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm'))) +
    theme(axis.text.x = element_text(angle=90, hjust=0, vjust=0))
```

"medium" group of lenders dominates across all sectors implying that almost all loans across all sectors have 10 - 50 lenders.

```{r}
borrower_prop <- loans %>% 
    group_by(sector, borrower_group) %>% 
    summarise(n=n()) %>% 
    mutate(percent=100*n/sum(n))
ggplot(borrower_prop, aes(sector, percent, color=borrower_group, fill=borrower_group)) + 
    geom_bar(position="dodge", stat = "identity") +
    labs(x = "Sector", y = "% Count", title = "% Borrowers By Sector") +
    theme(panel.border = element_rect(linetype = "solid", colour = "darkgreen", fill=NA, size = rel(1.2)),
          plot.title = element_text(size = rel(1.5), hjust='0.5', margin = margin(0, 0, 10, 0, 'mm')),
          panel.background = element_rect(fill = "white"),
          panel.grid.major = element_line(colour = "darkgreen", linetype = "solid", size = rel(0.2)),
          panel.grid.minor = element_line(colour = "darkgreen", linetype = "dotted", size = rel(0.2)),
          axis.ticks = element_line(colour = "darkgreen", size = rel(1.2)),
          axis.text.y = element_text(margin = margin(0, 2, 0, 5, 'mm')),
          axis.text.x = element_text(margin = margin(2, 0, 5, 0, 'mm'))) +
    theme(axis.text.x = element_text(angle=90, hjust=0, vjust=0))
```

Individual borrowers are dominate across all sectors, even in the least favorite sectors like "Entertainment". Large group of borrowers are frequently lesser in all the sectors. People like to run projects on their own - sole proprietorship model of business is evident here and it is a common trait of microenterprises.


### Borrowing over time



#### bonus_credit_eligibility



```{r}
levels(loans$bonus_credit_eligibility)
```

```{r}
table(loans$bonus_credit_eligibility)
```

```{r}
ggplot(loans, aes(bonus_credit_eligibility, ..count..)) + geom_bar()
```